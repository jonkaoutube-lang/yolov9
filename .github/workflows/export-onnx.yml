name: Export YOLOv9 ONNX Model

on:
  workflow_dispatch:
    inputs:
      model_size:
        description: 'YOLOv9 Model Size (t, s, m, c, e)'
        required: true
        default: 't'
      img_size:
        description: 'Image Size (320, 640)'
        required: true
        default: '320'

jobs:
  build-and-export:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      # This step is essential: it downloads your repository's code (your forked yolov9)
      uses: actions/checkout@v4
      # Note: This puts the code in the root of the workspace /home/runner/work/yolov9/yolov9

    - name: Run Docker Build Command
      run: |
        MODEL_SIZE=${{ github.event.inputs.model_size }}
        IMG_SIZE=${{ github.event.inputs.img_size }}

        # We need to write the Dockerfile content to a temporary file first
        # We change the ADD commands to better use the build context and wget
        cat <<'EOF' > Dockerfile.temp
        FROM python:3.11 AS build
        # We don't use ADD github.com . anymore
        # because the 'actions/checkout' step already checked out the files into our context
        RUN apt-get update && apt-get install --no-install-recommends -y libgl1 wget && rm -rf /var/lib/apt/lists/*
        COPY --from=ghcr.io/astral-sh/uv:0.8.0 /uv /bin/
        WORKDIR /yolov9

        # Copy the *local* checked out code into the docker build context
        COPY . .

        RUN uv pip install --system -r requirements.txt
        RUN uv pip install --system onnx==1.18.0 onnxruntime onnx-simplifier>=0.4.1 onnxscript
        ARG MODEL_SIZE
        ARG IMG_SIZE

        # Use WGET inside the container to download the weights reliably
        RUN wget github.com\${MODEL_SIZE}-converted.pt -O yolov9-\${MODEL_SIZE}.pt

        RUN sed -i "s/ckpt = torch.load(attempt_download(w), map_location='cpu')/ckpt = torch.load(attempt_download(w), map_location='cpu', weights_only=False)/g" models/experimental.py
        RUN python3 export.py --weights ./yolov9-\${MODEL_SIZE}.pt --imgsz \${IMG_SIZE} --simplify --include onnx

        FROM scratch
        ARG MODEL_SIZE
        ARG IMG_SIZE
        COPY --from=build /yolov9/yolov9-\${MODEL_SIZE}.onnx /yolov9-\${MODEL_SIZE}-\${IMG_SIZE}.onnx
        EOF

        # Run the docker build command using the inputs provided in the UI
        docker build . \
          --build-arg MODEL_SIZE=$MODEL_SIZE \
          --build-arg IMG_SIZE=$IMG_SIZE \
          --output . \
          -f Dockerfile.temp

    - name: Upload ONNX artifact
      uses: actions/upload-artifact@v4
      with:
        name: yolov9-onnx-model
        path: |
          *.onnx
